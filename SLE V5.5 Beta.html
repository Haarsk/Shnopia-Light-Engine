<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shnopia Light Engine V5.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Orbitron:wght@500;900&family=Anton&family=Bebas+Neue&family=Press+Start+2P&family=Lobster&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        :root { --panel-bg: rgba(15, 15, 15, 0.98); --accent: #f5a623; --text: #e0e0e0; --danger: #ff0000; --success: #00ff00; --track-inactive: #444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Roboto Mono', monospace; color: var(--text); user-select: none; -webkit-user-select: none; overscroll-behavior: none; }

        /* --- LAYERS --- */
        #light-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; image-rendering: pixelated; }
        #text-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: auto; }

        /* --- PANEL --- */
        .control-panel {
            position: absolute; pointer-events: auto; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--panel-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid #444; border-radius: 12px; width: 95%; max-width: 600px; height: 95vh; max-height: 950px;
            display: flex; flex-direction: column; box-shadow: 0 40px 100px #000; overflow: hidden; transition: opacity 0.3s, transform 0.3s; z-index: 2000;
        }
        .control-panel.hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -50%) scale(0.9); }
        @media (max-width: 768px) {
            .control-panel { width: 100%; height: 100dvh; max-width: none; max-height: none; top: 0; left: 0; transform: none; border-radius: 0; border: none; }
            .control-panel.hidden { transform: translateY(100%); opacity: 0; }
            .drag-bar { display: none !important; }
            .panel-header { padding: 5px 10px; height: 45px; }
        }

        /* --- HEADER --- */
        .drag-bar { height: 15px; background: linear-gradient(to bottom, #2a2a2a, #1a1a1a); border-bottom: 1px solid #000; cursor: grab; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .drag-bar:active { cursor: grabbing; }
        .grip-lines { width: 50px; height: 100%; background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, #555 2px, #555 3px); opacity: 0.3; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #1a1a1a; border-bottom: 1px solid #333; flex-shrink: 0; height: 50px; }
        .app-title { font-family: 'Orbitron'; font-weight: 900; font-size: 14px; letter-spacing: 1px; color: #d4af37; background: -webkit-linear-gradient(#ffd700, #d4af37, #b8860b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-right: auto; }
        .header-preview-box { width: 50px; height: 28px; background: #000; border: 1px solid #666; border-radius: 3px; margin-right: 10px; cursor: pointer; overflow: hidden; }
        #preview-canvas { width: 100%; height: 100%; display: block; object-fit: contain; }
        .preview-container { display: flex; align-items: center; margin-right: 10px; }
        .preview-label { font-family: 'Orbitron'; font-size: 9px; color: #888; margin-right: 5px; font-weight: bold; }
        .hide-btn { background: #333; border: 1px solid #555; color: #aaa; font-family: 'Orbitron'; font-size: 9px; font-weight: bold; padding: 4px 8px; border-radius: 4px; cursor: pointer; height: 26px; }

        /* --- TABS --- */
        .tabs { display: flex; background: #111; flex-shrink: 0; border-bottom: 1px solid #333; overflow-x: auto; height: 36px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 1; padding: 0 5px; min-width: 50px; background: transparent; border: none; color: #666; font-family: inherit; font-weight: bold; font-size: 10px; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; white-space: nowrap; }
        .tab-btn.active { color: #fff; border-bottom: 3px solid var(--accent); background: #222; }

        /* --- CONTENT --- */
        .panel-content { flex: 1; padding: 15px; display: none; flex-direction: column; overflow-y: auto; background: #161616; min-height: 0; }
        .panel-content.visible { display: flex; }

        /* --- SLIDERS --- */
        .control-group { margin-bottom: 8px; flex-shrink: 0; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 9px; color: #888; font-weight: bold; font-family: 'Orbitron'; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 0; touch-action: none; display: block; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 12px; cursor: pointer; background: #888; border-radius: 2px; border: 1px solid #000; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 12px; background: #000; border: 1px solid #fff; border-radius: 2px; cursor: pointer; margin-top: -7px; box-shadow: 1px 1px 4px rgba(0,0,0,0.8); }

        /* --- MODIFIERS --- */
        .modifier-slider input[type=range]::-webkit-slider-runnable-track { height: 30px; background: #333; border: 1px solid #555; transition: background 0.2s, box-shadow 0.2s; }
        .modifier-slider input[type=range]::-webkit-slider-thumb { height: 30px; width: 30px; background: #ccc; border: 2px solid #000; margin-top: -1px; }
        .modifier-slider.active input[type=range]::-webkit-slider-runnable-track { background: #004400; box-shadow: inset 0 0 10px #00ff00; border-color: #00ff00; }
        .modifier-slider.active input[type=range]::-webkit-slider-thumb { background: #fff; border-color: #00ff00; box-shadow: 0 0 10px #00ff00; }

        /* --- COLOR WHEEL --- */
        .wheel-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 140px; }
        .wheel-container { position: relative; width: min(200px, 35vh); height: min(200px, 35vh); border-radius: 50%; background: conic-gradient(red, yellow, lime, cyan, blue, magenta, red); box-shadow: inset 0 0 30px rgba(0,0,0,0.4), 0 0 0 3px #222; cursor: crosshair; touch-action: none; }
        .wheel-container::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; border-radius: 50%; background: radial-gradient(circle, white 0%, transparent 70%); pointer-events: none; }
        .wheel-cursor { position: absolute; width: 14px; height: 14px; border: 2px solid #000; background: rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        
        .rgb-row { display: flex; gap: 4px; margin-top: 5px; flex-shrink: 0; }
        .rgb-field { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .rgb-field input { width: 100%; background: #222; border: 1px solid #444; padding: 4px; border-radius: 3px; text-align: center; font-family: 'Roboto Mono'; font-weight: bold; color: #fff; font-size: 11px; }
        .hex-input { width: 100%; text-align: center; font-family: 'Roboto Mono'; font-weight: bold; font-size: 14px; background: #222; color: #fff; padding: 4px; margin-top: 4px; border-radius: 3px; border: 1px solid #444; text-transform: uppercase; }

        .memory-section { margin-top: auto; padding-top: 10px; flex-shrink: 0; }
        .memory-label { font-size: 8px; color: #666; text-align: center; margin-bottom: 4px; font-family: 'Orbitron'; }
        .memory-row { display: flex; gap: 6px; justify-content: space-between; height: 40px; }
        .memory-btn { flex: 1; border-radius: 4px; border: 1px solid #444; cursor: pointer; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .memory-btn:active { transform: scale(0.95); border-color: #fff; }

        .presets-row { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .preset-btn { flex: 1; background: #222; border: 1px solid #333; color: #aaa; padding: 8px 0; border-radius: 3px; font-size: 9px; font-weight: bold; cursor: pointer; text-align: center; min-width: 50px; }
        .preset-btn:hover { background: #333; color: #fff; }

        /* --- FX GRIDS --- */
        .fx-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; flex: 1; overflow-y: auto; padding-right: 2px; align-content: start; min-height: 0; }
        .fx-card { background: #2a2a2a; border: 1px solid #333; border-radius: 4px; padding: 0; text-align: center; cursor: pointer; height: 35px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .fx-card span { font-size: 8px; font-weight: bold; text-transform: uppercase; line-height: 1; pointer-events: none; }
        .fx-card.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .palette-container { display: flex; gap: 4px; justify-content: space-between; background: #111; padding: 4px; border-radius: 4px; border: 1px solid #333; margin-top: 4px; flex-shrink: 0; }
        .palette-item { display: flex; flex-direction: column; gap: 2px; align-items: center; flex: 1; }
        .palette-toggle { width: 100%; height: 6px; background: #333; border: 1px solid #555; border-radius: 2px; cursor: pointer; }
        .palette-toggle.active { background: #0f0; border-color: #0f0; box-shadow: 0 0 4px #0f0; }
        .palette-display { width: 100%; height: 16px; border-radius: 2px; border: 1px solid #444; }

        /* --- MATRIX --- */
        .matrix-section { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow: hidden; background: #111; border: 1px solid #333; border-radius: 4px; padding: 10px; }
        .mapping-list { flex: 1.5; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(5, 1fr); gap: 5px; overflow-y: auto; }
        .map-btn { background: #222; border: 1px solid #333; color: #888; padding: 0 5px; border-radius: 3px; font-size: 9px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .map-btn span { display: block; line-height: 1.1; }
        .map-btn.active-map { background: #004400; color: #0f0; border-color: #0f0; box-shadow: 0 0 10px rgba(0,255,0,0.5); text-shadow: 0 0 2px #0f0; }
        .map-set-display { font-family: 'Orbitron'; color: #0f0; font-size: 8px; margin-top: 2px; }
        .modifiers-container { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; border-top: 1px solid #333; padding-top: 5px; }

        /* --- FOOTER --- */
        .panel-footer { padding: 10px 15px; background: #111; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .footer-buttons { display: flex; gap: 8px; height: 36px; }
        .led-btn { flex: 1; border-radius: 4px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; text-align: center; }
        .blackout-btn { background: #300; color: #700; border: 1px solid #500; flex: 1.2; }
        .blackout-btn.active { background: var(--danger); color: white; border-color: #fff; box-shadow: 0 0 10px var(--danger); animation: pulse 0.5s infinite alternate; }
        .fullscreen-btn { background: #002200; color: #050; border: 2px solid #050; flex: 1; transition: background 0.2s, color 0.2s; }
        .fullscreen-btn:hover { color: var(--success); border-color: var(--success); }
        .fullscreen-btn.active { background: #006600 !important; color: #fff !important; border-color: #00ff00 !important; box-shadow: 0 0 15px #00ff00; text-shadow: 0 0 5px #fff; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.7; } }
        
        .activate-btn { width: 100%; padding: 8px; margin-top: 8px; background: #002200; color: #0f0; border: 1px solid #0f0; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 11px; flex-shrink: 0; }
        .activate-btn:hover { background: #0f0; color: #000; }
        
        .recall-btn { width: 100%; padding: 6px; margin-top: 8px; background: #222; color: #ccc; border: 1px solid #555; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 10px; flex-shrink: 0; text-transform: uppercase; }
        .recall-btn:hover { background: #333; color: #fff; border-color: #888; }
        
        .signature { text-align: center; font-size: 8px; color: #444; margin-top: 2px; font-family: 'Orbitron'; opacity: 0.6; }
        
        .text-input-wrapper { background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #000; }
        #text-content { width: 100%; border: none; outline: none; font-family: 'Roboto Mono', monospace; font-size: 16px; font-weight: bold; color: #000; background: transparent; text-transform: uppercase; }
        .text-toggle-btn { width: 100%; padding: 10px; margin-top:10px; border-radius: 6px; background: #222; color: #888; border: 2px solid #444; font-weight: bold; font-family: 'Orbitron'; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .text-toggle-btn.active { background: #004400; color: #0f0; border-color: #0f0; box-shadow: 0 0 10px rgba(0,255,0,0.5); }
        .dropdown { width: 100%; background: #222; color: #ccc; border: 1px solid #444; padding: 5px; font-family: 'Roboto Mono'; font-size: 11px; border-radius: 3px; margin-top: 2px; }
        
        .help-signature { font-family: 'Orbitron'; font-size: 12px; color: var(--accent); text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .help-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .help-title { color: #fff; font-family: 'Orbitron'; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
        .help-text { font-size: 10px; color: #888; line-height: 1.5; text-align: justify; }
        
        .lang-selector { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap; }
        .lang-btn { background: #333; border: 1px solid #555; color: #aaa; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .lang-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        .rossignol-box { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; padding: 10px; background: #1a1a1a; border-radius: 6px; border: 1px solid #333; }
        .rossignol-brand { font-family: 'Orbitron'; font-size: 11px; color: #ddd; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .rossignol-icon { font-size: 16px; }
        .contact-link { font-family: 'Roboto Mono'; font-size: 9px; color: #888; text-decoration: none; border-bottom: 1px dotted #555; }
        .contact-link:hover { color: #fff; border-color: #fff; }

        /* MODAL CUSTOM MATRIX */
        #modal-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
            display: none; justify-content: center; align-items: center; z-index: 3000; pointer-events: auto;
        }
        .modal-box { 
            background: #222; border: 2px solid var(--accent); padding: 20px; border-radius: 8px; 
            text-align: center; width: 80%; max-width: 300px; 
        }
        .modal-title { font-family: 'Orbitron'; color: var(--accent); margin-bottom: 15px; font-size: 14px; }
        .modal-input-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .modal-input-grp { display: flex; flex-direction: column; }
        .modal-input-grp label { font-size: 9px; color: #888; margin-bottom: 5px; }
        .modal-input-grp input { width: 60px; padding: 5px; background: #000; border: 1px solid #555; color: #fff; text-align: center; }
        .modal-btn { padding: 8px 20px; background: var(--accent); border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        #cork-icon { display: none !important; }

    </style>
</head>
<body>

    <canvas id="light-canvas"></canvas>
    <canvas id="text-canvas"></canvas>
    <div id="cork-icon"></div>

    <div id="modal-overlay" onclick="closeModalOnOutside(event)">
        <div class="modal-box">
            <div class="modal-title">CUSTOM MATRIX</div>
            <div class="modal-input-row">
                <div class="modal-input-grp">
                    <label>COLS</label>
                    <input type="number" id="custom-w" value="50" min="1">
                </div>
                <div class="modal-input-grp">
                    <label>ROWS</label>
                    <input type="number" id="custom-h" value="50" min="1">
                </div>
            </div>
            <button class="modal-btn" onclick="applyCustomMatrix()">APPLY</button>
        </div>
    </div>

    <div id="ui-layer" onclick="handleGlobalClick(event)">
        <div class="control-panel" id="main-panel" onclick="event.stopPropagation()">
            <div class="drag-bar" id="drag-handle"><div class="grip-lines"></div></div>
            <div class="panel-header">
                <span class="app-title">Shnopia Light Engine V5.5</span>
                <div class="preview-container"><span class="preview-label">PREVIEW</span><div class="header-preview-box" onclick="togglePreviewFS()"><canvas id="preview-canvas"></canvas></div></div>
                <button class="hide-btn" onclick="minimizePanel()">HIDE ME</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tab-wheel', this)">COLOR</button>
                <button class="tab-btn" onclick="switchTab('tab-cct', this)">WHITE</button>
                <button class="tab-btn" onclick="switchTab('tab-fx', this)">CINEMA FX</button>
                <button class="tab-btn" onclick="switchTab('tab-custom', this)">SHNOPIA FX</button>
                <button class="tab-btn" onclick="switchTab('tab-matrix', this)">MATRIX</button>
                <button class="tab-btn" onclick="switchTab('tab-text', this)">TEXT</button>
                <button class="tab-btn" onclick="switchTab('tab-help', this)">HOW TO USE</button>
            </div>

            <div id="tab-wheel" class="panel-content visible">
                <div class="wheel-wrapper"><div class="wheel-container" id="color-wheel"><div class="wheel-cursor" id="wheel-cursor"></div></div></div>
                <div class="control-group">
                    <div class="label-row"><span>SATURATION</span><span id="val-sat">100%</span></div>
                    <input type="range" min="0" max="100" value="100" id="input-sat">
                </div>
                <input type="text" class="hex-input" id="hex-input" value="#FF0000" maxlength="7">
                <div class="rgb-row">
                    <div class="rgb-field"><label>R</label><input type="number" id="input-r" min="0" max="255"></div>
                    <div class="rgb-field"><label>G</label><input type="number" id="input-g" min="0" max="255"></div>
                    <div class="rgb-field"><label>B</label><input type="number" id="input-b" min="0" max="255"></div>
                </div>
                <button class="recall-btn" onclick="recallWhite()">RECALL WHITE SETTINGS</button>
                <button class="activate-btn" onclick="activateStatic('WHEEL')">ACTIVER LA COULEUR</button>
                
                <div class="memory-section">
                    <div class="memory-label">M√âMOIRES (CLIQUEZ POUR SAUVER)</div>
                    <div class="memory-row" id="color-memories"></div>
                </div>
            </div>

            <div id="tab-cct" class="panel-content">
                <div class="control-group">
                    <div class="label-row"><span>TEMPERATURE (KELVIN)</span><span id="val-kelvin">3200K</span></div>
                    <input type="range" min="1750" max="10000" value="3200" id="input-kelvin">
                    <div class="presets-row">
                        <button class="preset-btn" onclick="setKelvin(2700)">2700K</button>
                        <button class="preset-btn" onclick="setKelvin(3200)">3200K</button>
                        <button class="preset-btn" onclick="setKelvin(4300)">4300K</button>
                        <button class="preset-btn" onclick="setKelvin(5600)">5600K</button>
                        <button class="preset-btn" onclick="setKelvin(6500)">6500K</button>
                    </div>
                </div>
                <div class="control-group" style="margin-top:15px;">
                    <div class="label-row"><span>TINT (G/M)</span><span id="val-tint">0</span></div>
                    <input type="range" min="-50" max="50" value="0" id="input-tint">
                </div>
                <div class="label-row" style="margin-top:15px;"><span>MANUEL BLANC</span></div>
                <input type="text" class="hex-input" id="hex-input-white" value="#FFFFFF" maxlength="7">
                <div class="rgb-row">
                    <div class="rgb-field"><label>R</label><input type="number" id="input-white-r" min="0" max="255"></div>
                    <div class="rgb-field"><label>G</label><input type="number" id="input-white-g" min="0" max="255"></div>
                    <div class="rgb-field"><label>B</label><input type="number" id="input-white-b" min="0" max="255"></div>
                </div>
                
                <button class="activate-btn" onclick="activateStatic('CCT')">ACTIVER LE BLANC</button>
            </div>

            <div id="tab-fx" class="panel-content">
                <div class="control-group">
                    <div class="label-row"><span>SPEED</span><span id="val-speed">50%</span></div>
                    <input type="range" min="1" max="100" value="50" id="input-speed">
                </div>
                <div class="label-row" style="margin-top:2px;"><span>COLOR OVERRIDE (FROM MEMORIES)</span></div>
                <div class="palette-container" id="palette-fx"></div>
                <div class="fx-grid" id="cinema-grid" style="margin-top:5px;"></div>
            </div>

            <div id="tab-custom" class="panel-content">
                <div class="control-group">
                    <div class="label-row"><span>SPEED</span><span id="val-speed-shnopia">50%</span></div>
                    <input type="range" min="1" max="100" value="50" id="input-speed-shnopia">
                </div>
                <div class="label-row" style="margin-top:2px;"><span>COLOR OVERRIDE (FROM MEMORIES)</span></div>
                <div class="palette-container" id="palette-shnopia"></div>
                <div class="fx-grid" id="shnopia-grid" style="margin-top:5px;"></div>
            </div>

            <div id="tab-matrix" class="panel-content">
                <div class="matrix-section" style="height:auto; flex:1;">
                    <div class="label-row">PRESETS</div>
                    <div class="mapping-list" style="grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(5, 1fr);">
                        <div class="map-btn active-map" onclick="setMapMode(0, this)"><span>Titan</span><span>8x16</span></div>
                        <div class="map-btn" onclick="setMapMode(1, this)"><span>Matrix</span><span>60x30</span></div>
                        <div class="map-btn" onclick="setMapMode(2, this)"><span>Single</span><span>1x1</span></div>
                        <div class="map-btn" onclick="setMapMode(3, this)"><span>2-Lite</span><span>2x1</span></div>
                        <div class="map-btn" onclick="setMapMode(4, this)"><span>4-Lite</span><span>2x2</span></div>
                        <div class="map-btn" onclick="setMapMode(5, this)"><span>Bar</span><span>60x1</span></div>
                        <div class="map-btn" onclick="setMapMode(6, this)"><span>Retro</span><span>10x5</span></div>
                        <div class="map-btn" onclick="setMapMode(7, this)"><span>Soft</span><span>20x10</span></div>
                        <div class="map-btn" onclick="setMapMode(8, this)"><span>Strip</span><span>1x40</span></div>
                        <div class="map-btn" onclick="setMapMode(9, this)"><span>UHD</span><span>100x50</span></div>
                        <div class="map-btn" onclick="setMapMode(10, this)"><span>Wide</span><span>16x9</span></div>
                        <div class="map-btn" onclick="setMapMode(11, this)"><span>4:3</span><span>12x9</span></div>
                        <div class="map-btn" onclick="setMapMode(12, this)"><span>Sq.Lo</span><span>8x8</span></div>
                        <div class="map-btn" onclick="setMapMode(13, this)"><span>Sq.Hi</span><span>32x32</span></div>
                        
                        <div class="map-btn" id="btn-set" onclick="showCustomMatrixModal()"><span>SET</span><span id="set-display" class="map-set-display">--x--</span></div>
                    </div>
                    
                    <div class="label-row" style="margin-top:15px;">MODIFIERS</div>
                    <div class="modifiers-container">
                        <div class="control-group modifier-slider" id="grp-grid">
                            <div class="label-row"><span>MULTIPLIER</span><span id="val-grid-lvl">x1</span></div>
                            <input type="range" min="1" max="10" value="1" id="input-grid-lvl" oninput="updateGridSlider(this)">
                        </div>
                        <div class="control-group modifier-slider" id="grp-warp">
                            <div class="label-row"><span>WARP</span><span id="val-warp-lvl">0</span></div>
                            <input type="range" min="0" max="10" value="0" id="input-warp-lvl" oninput="updateWarpSlider(this)">
                        </div>
                        <div class="control-group modifier-slider" id="grp-noise">
                            <div class="label-row"><span>NOISE</span><span id="val-noise-lvl">0</span></div>
                            <input type="range" min="0" max="10" value="0" id="input-noise-lvl" oninput="updateNoiseSlider(this)">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-text" class="panel-content">
                <div class="control-group"><div class="label-row"><span>MESSAGE</span></div><div class="text-input-wrapper"><input type="text" id="text-content" placeholder="TAPEZ ICI" value="Shnopia Light Engine enhances your set"></div></div>
                <button class="text-toggle-btn" id="btn-text-toggle" onclick="toggleText()">TEXTE: OFF</button>
                <div style="margin-top: 10px;">
                    <div class="control-group"><div class="label-row"><span>POLICE</span></div><select id="input-text-font" class="dropdown"><option value="'Roboto Mono', monospace">Standard Tech</option><option value="'Bebas Neue', sans-serif">Cin√©ma</option><option value="'Press Start 2P', cursive">Pixel</option><option value="'Lobster', cursive">Manuscrit</option><option value="'Orbitron', sans-serif">Futuriste</option></select></div>
                    <div class="control-group"><div class="label-row"><span>EFFET</span></div><select id="input-text-effect" class="dropdown"><option value="NONE">Aucun</option><option value="NEON">Neon</option><option value="GLITCH">Glitch</option><option value="WAVE">Wave</option><option value="TYPE">Typewriter</option><option value="STROKE">Outline</option></select></div>
                    <div class="control-group modifier-slider" id="grp-text-fx"><div class="label-row"><span>INTENSIT√â</span><span id="val-text-fx-lvl">50%</span></div><input type="range" min="0" max="100" value="50" id="input-text-fx-lvl" oninput="updateTextSlider()"></div>
                    <div class="control-group"><div class="label-row"><span>TAILLE</span><span id="val-text-size">50%</span></div><input type="range" min="5" max="100" value="50" id="input-text-size"></div>
                    <div class="control-group"><div class="label-row"><span>VITESSE</span><span id="val-text-speed">5</span></div><input type="range" min="0" max="30" value="5" id="input-text-speed"></div>
                    <div class="control-group"><div class="label-row"><span>COULEUR</span></div><input type="color" id="input-text-color" value="#ffffff" style="width:100%; height:30px; border:none; padding: 0;"></div>
                </div>
            </div>
            
            <div id="tab-help" class="panel-content">
                <div class="lang-selector"><button class="lang-btn active" onclick="setLang('FR', this)">FR</button><button class="lang-btn" onclick="setLang('EN', this)">EN</button><button class="lang-btn" onclick="setLang('ES', this)">ES</button><button class="lang-btn" onclick="setLang('RU', this)">RU</button><button class="lang-btn" onclick="setLang('JP', this)">JP</button></div>
                <div class="rossignol-box">
                    <span class="rossignol-brand"><span class="rossignol-icon">üê¶</span> Rossignol Grip Vibe Coding</span>
                    <a href="mailto:rossignol.p@gmail.com" class="contact-link">Contact: rossignol.p@gmail.com</a>
                </div>
                <div id="help-content"></div>
            </div>

            <div class="panel-footer">
                <div><div class="label-row"><span>INTENSIT√â</span><span id="val-dimmer">100%</span></div><input type="range" min="0" max="100" value="100" id="input-dimmer"></div>
                <div class="footer-buttons">
                    <button class="led-btn blackout-btn" id="btn-blackout" onclick="toggleBlackout()">BLACKOUT</button>
                    <button class="led-btn fullscreen-btn" onclick="toggleFS()">FULL SCREEN</button>
                </div>
                <div class="signature">D√©velopp√© par Shnopia par amour du cin√©ma</div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILS (HSV based for correct saturation logic) ---
        function hexToRgb(hex) { var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function rgbToHex(r,g,b) { return "#" + ((1<<24)+(Math.round(r)<<16)+(Math.round(g)<<8)+Math.round(b)).toString(16).slice(1).toUpperCase(); }
        
        // HSL Helper (Keep for legacy/internal FX if needed)
        function hslToRgb(h,s,l){ l/=100; s/=100; let k=n=>(n+h/30)%12, a=s*Math.min(l,1-l), f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))); return [f(0)*255,f(8)*255,f(4)*255]; }
        
        // HSV Helpers (New Engine)
        function rgbToHsv(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, v = max;
            var d = max - min;
            s = max == 0 ? 0 : d / max;
            if (max == min) { h = 0; } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, v: v * 100 };
        }

        function hsvToRgb(h, s, v) {
            var r, g, b;
            var i;
            var f, p, q, t;
            h = Math.max(0, Math.min(360, h));
            s = Math.max(0, Math.min(100, s));
            v = Math.max(0, Math.min(100, v));
            s /= 100; v /= 100;
            if(s == 0) { r = g = b = v; return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)]; }
            h /= 60; i = Math.floor(h); f = h - i; p = v * (1 - s); q = v * (1 - s * f); t = v * (1 - s * (1 - f));
            switch(i) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                default: r = v; g = p; b = q;
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function kelvinToRgb(k){ let t=k/100,r,g,b; if(t<=66){r=255;g=99.47*Math.log(t)-161.1;if(t<=19)b=0;else b=138.5*Math.log(t-10)-305;}else{r=329.7*Math.pow(t-60,-0.133);g=288.1*Math.pow(t-60,-0.075);b=255;} return{r:c(r),g:c(g),b:c(b)}; }
        function applyTint(rgb,t){ return {r:c(rgb.r-t*0.5), g:c(rgb.g+t*1.5), b:c(rgb.b-t*0.5)}; }
        function c(v){ return Math.max(0,Math.min(255,v)); }

        const canvas = document.getElementById('light-canvas'); const ctx = canvas.getContext('2d');
        const textCanvas = document.getElementById('text-canvas'); const textCtx = textCanvas.getContext('2d');
        const previewCanvas = document.getElementById('preview-canvas'); const previewCtx = previewCanvas.getContext('2d');
        
        // --- STATE ---
        let paletteState = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF'].map(c => ({ color: c, active: false }));

        let state = {
            mode: 'WHEEL', kelvin: 3200, tint: 0, hue: 0, sat: 100, val: 100, // Replaced Lightness with Value (HSV)
            dimmer: 100, blackout: false, fxMode: 0, speedCinema: 50, speedShnopia: 50, mapMode: 0,
            time: 0, 
            textOn: false, textString: "Shnopia Light Engine enhances your set", textSize: 50, textSpeed: 5, textColor: "#ffffff", textPos: 0,
            textFont: "'Roboto Mono', monospace", textEffect: "NONE", textFxLvl: 50,
            gridActive: true, gridLevel: 1, warpActive: false, warpLevel: 0, noiseActive: false, noiseLevel: 0,
            whiteRgb: {r:255, g:255, b:255}, savedColors: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF'], paletteActive: [false, false, false, false, false],
        };

        // --- MAPS ---
        const MAPS = [
            {w:8, h:16}, {w:60, h:30}, {w:1, h:1}, {w:2, h:1}, {w:2, h:2}, {w:60, h:1}, 
            {w:10, h:5}, {w:20, h:10}, {w:1, h:40}, {w:100, h:50}, {w:16, h:9}, {w:12, h:9}, 
            {w:8, h:8}, {w:32, h:32}, {w:50, h:50}
        ];
        
        const CINEMA_FX = [ "STATIC", "POLICE", "FIRE", "PAPARAZZI", "TV", "WELDING", "PROCESS", "BAD BULB", "STORM", "CANDLE", "STROBE", "EXPLOSION", "CLUB", "PAPA COLOR", "FLUORESCENT", "EMERGENCY", "FIREWORKS", "GUNSHOT", "RED ALERT", "ELEVATOR", "HORROR" ];
        const SHNOPIA_FX = [ "AURORA", "MATRIX", "CYBER", "PLASMA", "OCEAN", "LAVA", "DISCO", "SUNSET", "NEBULA", "BIFROST", "SCANNER", "RIPPLE", "SNOW", "GLITCH", "BINARY", "HEARTBEAT", "BIOHAZARD", "WARP", "RAIN", "VORTEX", "KALEIDO" ];

        // --- INITIAL SETUP ---
        function genGrid(targetId, names, offset) {
            const container = document.getElementById(targetId);
            names.forEach((name, i) => {
                const id = offset + i;
                const div = document.createElement('div'); div.className = 'fx-card'; if(id === 0) div.classList.add('active'); if(id===0) div.id='fx-static';
                div.innerHTML = `<span>${name}</span>`; div.onclick = () => setEffect(id, div);
                container.appendChild(div);
            });
        }
        genGrid('cinema-grid', CINEMA_FX, 0); genGrid('shnopia-grid', SHNOPIA_FX, 21);

        function updateMemoriesUI() {
            const container = document.getElementById('color-memories'); container.innerHTML = '';
            state.savedColors.forEach((col, i) => {
                const btn = document.createElement('div'); btn.className = 'memory-btn'; btn.style.backgroundColor = col; btn.onclick = () => saveMemory(i); container.appendChild(btn);
            });
        }
        function genPalette(targetId) {
            const container = document.getElementById(targetId); container.innerHTML = '';
            state.savedColors.forEach((col, i) => {
                const item = document.createElement('div'); item.className = 'palette-item';
                const toggle = document.createElement('div'); toggle.className = 'palette-toggle'; toggle.onclick = () => { state.paletteActive[i] = !state.paletteActive[i]; updatePaletteUI(); };
                const display = document.createElement('div'); display.className = 'palette-display'; display.style.backgroundColor = col;
                item.appendChild(toggle); item.appendChild(display); container.appendChild(item);
            });
        }
        genPalette('palette-fx'); genPalette('palette-shnopia');

        function updatePaletteUI() {
            ['palette-fx', 'palette-shnopia'].forEach(id => {
                const toggles = document.getElementById(id).getElementsByClassName('palette-toggle');
                const displays = document.getElementById(id).getElementsByClassName('palette-display');
                state.savedColors.forEach((col, i) => { if(toggles[i]) { if(state.paletteActive[i]) toggles[i].classList.add('active'); else toggles[i].classList.remove('active'); displays[i].style.backgroundColor = col; } });
            });
            updateMemoriesUI();
        }

        function saveMemory(index) {
            const rgb = hsvToRgb(state.hue, state.sat, state.val); const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
            state.savedColors[index] = hex; updatePaletteUI();
        }
        updateMemoriesUI();

        // --- HELP CONTENT ---
        const TRANSLATIONS = {
            FR: `
                <div class="help-signature">D√©velopp√© par Shnopia par amour du cin√©ma</div>
                <div class="help-section"><div class="help-title">INTRODUCTION</div><div class="help-text">Shnopia Light Engine transforme votre √©cran en source lumineuse professionnelle pour le cin√©ma et la photo. Cr√©ez des √©clairages dynamiques, des fonds color√©s et des effets de texte.</div></div>
                <div class="help-section"><div class="help-title">1. ONGLET COLOR</div><div class="help-text">Utilisez la roue chromatique pour s√©lectionner une teinte. Ajustez la <strong>SATURATION</strong> via le slider. Les valeurs RGB et HEX sont modifiables manuellement. Sauvegardez vos couleurs favorites dans les 5 boutons <strong>M√âMOIRES</strong> en bas.<br>Utilisez <strong>R√âCUP√âRER REGLAGES WHITE</strong> pour importer la couleur d√©finie dans l'onglet White vers la roue.</div></div>
                <div class="help-section"><div class="help-title">2. ONGLET WHITE</div><div class="help-text">Contr√¥le pr√©cis de la temp√©rature de couleur (CCT) de 1750K √† 10000K. Slider <strong>TINT</strong> pour la correction Vert/Magenta. Boutons rapides (presets) pour les valeurs standards. Vous pouvez aussi d√©finir un blanc manuel via RGB.</div></div>
                <div class="help-section"><div class="help-title">3. FX (CINEMA & SHNOPIA)</div><div class="help-text">S√©lectionnez un effet (Police, Fire, TV, etc.). R√©glez la vitesse globale. La section <strong>COLOR OVERRIDE</strong> permet de forcer l'utilisation de vos couleurs en m√©moire pour certains effets (activez les petits interrupteurs au-dessus des couleurs).</div></div>
                <div class="help-section"><div class="help-title">4. MATRIX</div><div class="help-text">Simule la r√©solution de pixels de votre √©cran. Choisissez un preset (ex: 8x16 pour un tube Titan, 1x1 pour un panneau). Le bouton <strong>SET</strong> ouvre une fen√™tre pour d√©finir une r√©solution personnalis√©e.<br><strong>MODIFIERS :</strong> Utilisez les curseurs tactiles pour multiplier les pixels (Grid), d√©former l'image (Warp) ou ajouter du grain (Noise).</div></div>
                <div class="help-section"><div class="help-title">5. TEXTE</div><div class="help-text">Affichez des messages d√©filants. Tapez votre texte, activez-le, choisissez la police, la couleur et la vitesse. Les effets (Neon, Glitch, Wave...) ajoutent du dynamisme.</div></div>
                <div class="help-section"><div class="help-title">6. CONTR√îLES G√âN√âRAUX</div><div class="help-text"><strong>INTENSIT√â :</strong> Master dimmer global.<br><strong>BLACKOUT :</strong> Coupe toute lumi√®re instantan√©ment.<br><strong>PREVIEW :</strong> La petite fen√™tre en haut montre le r√©sultat final. Cliquez dessus pour passer en plein √©cran.</div></div>
            `,
            EN: `
                <div class="help-signature">Developed by Shnopia for the love of cinema</div>
                <div class="help-section"><div class="help-title">INTRODUCTION</div><div class="help-text">Shnopia Light Engine turns your screen into a professional lighting source for film and photography. Create dynamic lighting, colorful backdrops, and text effects.</div></div>
                <div class="help-section"><div class="help-title">1. COLOR TAB</div><div class="help-text">Use the color wheel to select a hue. Adjust <strong>SATURATION</strong> with the slider. RGB and HEX values can be edited manually. Save your favorite colors to the 5 <strong>MEMORY</strong> buttons at the bottom.<br>Use <strong>RECALL WHITE SETTINGS</strong> to import the color defined in the White tab to the wheel.</div></div>
                <div class="help-section"><div class="help-title">2. WHITE TAB</div><div class="help-text">Precise Color Temperature (CCT) control from 1750K to 10000K. <strong>TINT</strong> slider for Green/Magenta correction. Quick preset buttons for standard values. You can also define a manual white via RGB.</div></div>
                <div class="help-section"><div class="help-title">3. FX (CINEMA & SHNOPIA)</div><div class="help-text">Select an effect (Police, Fire, TV, etc.). Adjust global speed. The <strong>COLOR OVERRIDE</strong> section allows you to force the use of your memory colors for certain effects (toggle the small switches above the colors).</div></div>
                <div class="help-section"><div class="help-title">4. MATRIX</div><div class="help-text">Simulates the pixel resolution of your screen. Choose a preset (e.g., 8x16 for a Titan tube, 1x1 for a panel). The <strong>SET</strong> button opens a window to define a custom resolution.<br><strong>MODIFIERS:</strong> Use the touch sliders to multiply pixels (Grid), distort the image (Warp), or add grain (Noise).</div></div>
                <div class="help-section"><div class="help-title">5. TEXT</div><div class="help-text">Display scrolling messages. Type your text, turn it on, choose font, color, and speed. Effects (Neon, Glitch, Wave...) add dynamism.</div></div>
                <div class="help-section"><div class="help-title">6. GENERAL CONTROLS</div><div class="help-text"><strong>INTENSITY:</strong> Global master dimmer.<br><strong>BLACKOUT:</strong> Cuts all light instantly.<br><strong>PREVIEW:</strong> The small window at the top shows the final result. Click on it to toggle full screen.</div></div>
            `,
            ES: `
                <div class="help-signature">Desarrollado por Shnopia por amor al cine</div>
                <div class="help-section"><div class="help-title">INTRODUCCI√ìN</div><div class="help-text">Shnopia Light Engine transforma tu pantalla en una fuente de luz profesional para cine y fotograf√≠a. Crea iluminaciones din√°micas y fondos coloridos.</div></div>
                <div class="help-section"><div class="help-title">1. PESTA√ëA COLOR</div><div class="help-text">Usa la rueda de color para seleccionar el tono. Ajusta la <strong>SATURACI√ìN</strong>. Guarda tus colores favoritos en las 5 <strong>MEMORIAS</strong>.<br>Usa <strong>RECUPERAR BLANCO</strong> para importar el color de la pesta√±a White.</div></div>
                <div class="help-section"><div class="help-title">2. PESTA√ëA WHITE</div><div class="help-text">Control de temperatura (CCT) de 1750K a 10000K. Slider <strong>TINT</strong> para correcci√≥n Verde/Magenta. Botones de presets r√°pidos.</div></div>
                <div class="help-section"><div class="help-title">3. FX (EFECTOS)</div><div class="help-text">Selecciona efectos como Polic√≠a, Fuego, TV. Ajusta la velocidad. La secci√≥n <strong>COLOR OVERRIDE</strong> usa tus colores guardados en los efectos.</div></div>
                <div class="help-section"><div class="help-title">4. MATRIX</div><div class="help-text">Simula la resoluci√≥n de p√≠xeles (ej: 8x16). El bot√≥n <strong>SET</strong> permite una resoluci√≥n personalizada.<br><strong>MODIFICADORES:</strong> Multiplicador de cuadr√≠cula, Deformaci√≥n (Warp) y Ruido (Noise).</div></div>
                <div class="help-section"><div class="help-title">5. TEXTO</div><div class="help-text">Muestra mensajes desplazables. Elige fuente, color y efectos como Neon o Glitch.</div></div>
                <div class="help-section"><div class="help-title">6. GENERAL</div><div class="help-text"><strong>INTENSIDAD:</strong> Dimmer maestro.<br><strong>BLACKOUT:</strong> Apagado total.<br><strong>FULL SCREEN:</strong> Pantalla completa.</div></div>
            `,
            RU: `
                <div class="help-signature">–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ Shnopia —Å –ª—é–±–æ–≤—å—é –∫ –∫–∏–Ω–æ</div>
                <div class="help-section"><div class="help-title">–í–í–ï–î–ï–ù–ò–ï</div><div class="help-text">Shnopia Light Engine –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤–∞—à —ç–∫—Ä–∞–Ω –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –∏ —Ü–≤–µ—Ç–Ω—ã–µ —Ñ–æ–Ω—ã.</div></div>
                <div class="help-section"><div class="help-title">1. –¶–í–ï–¢ (COLOR)</div><div class="help-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–≤–µ—Ç–æ–≤–æ–π –∫—Ä—É–≥. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ <strong>–ù–ê–°–´–©–ï–ù–ù–û–°–¢–¨</strong>. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ü–≤–µ—Ç–∞ –≤ 5 —è—á–µ–π–∫–∞—Ö <strong>–ü–ê–ú–Ø–¢–ò</strong>.<br>–ö–Ω–æ–ø–∫–∞ <strong>–í–ï–†–ù–£–¢–¨ –ë–ï–õ–´–ô</strong> –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ White.</div></div>
                <div class="help-section"><div class="help-title">2. –ë–ï–õ–´–ô (WHITE)</div><div class="help-text">–ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–≤–µ—Ç–æ–≤–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (CCT) –æ—Ç 1750K –¥–æ 10000K. –°–ª–∞–π–¥–µ—Ä <strong>–û–¢–¢–ï–ù–û–ö</strong> (Tint) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –ó–µ–ª–µ–Ω—ã–π/–ú–∞–¥–∂–µ–Ω—Ç–∞.</div></div>
                <div class="help-section"><div class="help-title">3. –≠–§–§–ï–ö–¢–´ (FX)</div><div class="help-text">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç (–ü–æ–ª–∏—Ü–∏—è, –û–≥–æ–Ω—å, –¢–í). –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å. <strong>COLOR OVERRIDE</strong> –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤ —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö.</div></div>
                <div class="help-section"><div class="help-title">4. –ú–ê–¢–†–ò–¶–ê (MATRIX)</div><div class="help-text">–°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–∏–∫—Å–µ–ª–µ–π (–Ω–∞–ø—Ä. 8x16). –ö–Ω–æ–ø–∫–∞ <strong>SET</strong> –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.<br><strong>–ú–û–î–ò–§–ò–ö–ê–¢–û–†–´:</strong> –°–µ—Ç–∫–∞, –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è (Warp), –®—É–º (Noise).</div></div>
                <div class="help-section"><div class="help-title">5. –¢–ï–ö–°–¢</div><div class="help-text">–ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞. –í—ã–±–æ—Ä —à—Ä–∏—Ñ—Ç–∞, —Ü–≤–µ—Ç–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–ù–µ–æ–Ω, –ì–ª–∏—Ç—á).</div></div>
                <div class="help-section"><div class="help-title">6. –û–ë–©–ï–ï</div><div class="help-text"><strong>–Ø–†–ö–û–°–¢–¨:</strong> –û–±—â–∏–π –¥–∏–º–º–µ—Ä.<br><strong>BLACKOUT:</strong> –ü–æ–ª–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ.<br><strong>FULL SCREEN:</strong> –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω.</div></div>
            `,
            JP: `
                <div class="help-signature">Êò†ÁîªÊÑõ„ÅÆ„Åü„ÇÅ„Å´Shnopia„Å´„Çà„Å£„Å¶ÈñãÁô∫„Åï„Çå„Åæ„Åó„Åü</div>
                <div class="help-section"><div class="help-title">„ÅØ„Åò„ÇÅ„Å´</div><div class="help-text">Shnopia Light Engine„ÅØ„ÄÅÁîªÈù¢„Çí„Éó„É≠‰ªïÊßò„ÅÆÁÖßÊòéÂÖâÊ∫ê„Å´Â§â„Åà„Åæ„Åô„ÄÇ„ÉÄ„Ç§„Éä„Éü„ÉÉ„ÇØ„Å™ÁÖßÊòé„ÇÑ„ÉÜ„Ç≠„Çπ„ÉàÂäπÊûú„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">1. „Ç´„É©„Éº (COLOR)</div><div class="help-text">„Ç´„É©„Éº„Éõ„Ç§„Éº„É´„ÅßËâ≤Áõ∏„ÇíÈÅ∏Êäû„ÄÇ<strong>ÂΩ©Â∫¶</strong>„ÇíË™øÊï¥„ÄÇ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆËâ≤„Çí5„Å§„ÅÆ<strong>„É°„É¢„É™</strong>„Å´‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ<br><strong>„Éõ„ÉØ„Ç§„ÉàË®≠ÂÆö„ÇíÂëº„Å≥Âá∫„Åó</strong>„Éú„Çø„É≥„Åß„ÄÅWhite„Çø„Éñ„ÅÆË®≠ÂÆö„ÇíÂèçÊò†„Åß„Åç„Åæ„Åô„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">2. „Éõ„ÉØ„Ç§„Éà (WHITE)</div><div class="help-text">Ëâ≤Ê∏©Â∫¶ÔºàCCTÔºâ„Çí1750K„Åã„Çâ10000K„Åæ„ÅßÂà∂Âæ°„ÄÇ<strong>TINT</strong>„Çπ„É©„Ç§„ÉÄ„Éº„ÅßÁ∑ë/„Éû„Çº„É≥„ÇøË£úÊ≠£„ÅåÂèØËÉΩ„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">3. „Ç®„Éï„Çß„ÇØ„Éà (FX)</div><div class="help-text">„Éë„Éà„Ç´„Éº„ÄÅÁÇé„ÄÅ„ÉÜ„É¨„Éì„Å™„Å©„ÅÆÂäπÊûú„ÇíÈÅ∏Êäû„ÄÇÈÄüÂ∫¶„ÇíË™øÊï¥„ÄÇ<strong>COLOR OVERRIDE</strong>„Åß‰øùÂ≠ò„Åó„ÅüËâ≤„Çí„Ç®„Éï„Çß„ÇØ„Éà„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">4. „Éû„Éà„É™„ÉÉ„ÇØ„Çπ (MATRIX)</div><div class="help-text">ÁîªÈù¢„ÅÆ„Éî„ÇØ„Çª„É´Ëß£ÂÉèÂ∫¶„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºà‰æãÔºö8x16Ôºâ„ÄÇ<strong>SET</strong>„Éú„Çø„É≥„Åß„Ç´„Çπ„Çø„É†Ëß£ÂÉèÂ∫¶„ÇíË®≠ÂÆöÂèØËÉΩ„ÄÇ<br><strong>‰øÆÈ£æÂ≠êÔºö</strong>„Ç∞„É™„ÉÉ„Éâ„ÄÅ„ÉØ„Éº„Éó„ÄÅ„Éé„Ç§„Ç∫„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">5. „ÉÜ„Ç≠„Çπ„Éà</div><div class="help-text">„Çπ„ÇØ„É≠„Éº„É´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„ÄÇ„Éï„Ç©„É≥„Éà„ÄÅËâ≤„ÄÅ„Ç®„Éï„Çß„ÇØ„ÉàÔºà„Éç„Ç™„É≥„ÄÅ„Ç∞„É™„ÉÉ„ÉÅ„Å™„Å©Ôºâ„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇ</div></div>
                <div class="help-section"><div class="help-title">6. ‰∏ÄËà¨</div><div class="help-text"><strong>Âº∑Â∫¶Ôºö</strong>ÂÖ®‰ΩìÁöÑ„Å™Êòé„Çã„Åï„ÄÇ<br><strong>„Éñ„É©„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºö</strong>Áû¨ÊôÇ„Å´Ê∂àÁÅØ„ÄÇ<br><strong>„Éï„É´„Çπ„ÇØ„É™„Éº„É≥Ôºö</strong>ÂÖ®ÁîªÈù¢Ë°®Á§∫„ÄÇ</div></div>
            `
        };
        function setLang(lang, btn) { document.getElementById('help-content').innerHTML = TRANSLATIONS[lang] || TRANSLATIONS['FR']; document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); }
        setLang('FR', document.querySelector('.lang-btn.active'));

        // --- RENDER LOOP ---
        let stormFlash = 0;

        function render() {
            let baseMap = MAPS[state.mapMode] || MAPS[0]; 
            let multiplier = state.gridActive ? state.gridLevel : 1;
            let targetW = baseMap.w * multiplier; let targetH = baseMap.h * multiplier;

            if(canvas.width !== targetW) canvas.width = targetW;
            if(canvas.height !== targetH) canvas.height = targetH;
            
            if(textCanvas.width !== window.innerWidth || textCanvas.height !== window.innerHeight) { 
                textCanvas.width = window.innerWidth; textCanvas.height = window.innerHeight; 
            }

            if(state.blackout) { 
                ctx.fillStyle = "black"; ctx.fillRect(0, 0, targetW, targetH); 
                textCtx.clearRect(0, 0, textCanvas.width, textCanvas.height); 
                requestAnimationFrame(render); return; 
            }

            const imgData = ctx.createImageData(targetW, targetH); const data = imgData.data;
            let currentSpeed = state.fxMode <= 20 ? state.speedCinema : state.speedShnopia;
            state.time += (currentSpeed / 50) * 0.05; 
            const t = state.time; const w = targetW; const h = targetH;

            if(state.fxMode === 8) { if(Math.random() > 0.98) stormFlash = 1; else stormFlash *= 0.85; if(stormFlash < 0.01) stormFlash = 0.02; }

            const activeColors = state.savedColors.filter((c, i) => state.paletteActive[i]).map(hex => hexToRgb(hex)); 
            const usePalette = activeColors.length > 0 && state.fxMode !== 0;
            let rB, gB, bB;
            
            // --- MAIN COLOR LOGIC SWITCHED TO HSV ---
            if (state.mode === 'WHEEL') { 
                const rgb = hsvToRgb(state.hue, state.sat, state.val); 
                rB=rgb[0]; gB=rgb[1]; bB=rgb[2]; 
            } 
            else if (state.mode === 'CCT') { rB=state.whiteRgb.r; gB=state.whiteRgb.g; bB=state.whiteRgb.b; } 
            else { rB=0; gB=0; bB=0; }

            const p = (idx, r,g,b, i=1, x, y) => { 
                if(state.warpActive && state.warpLevel > 0) { let offset = Math.sin(y * 0.1 * state.warpLevel + t) * (state.warpLevel * 2); i *= (0.5 + 0.5 * Math.sin(offset)); }
                if(state.noiseActive && state.noiseLevel > 0) { if(Math.random() < state.noiseLevel * 0.05) { r=255; g=255; b=255; } else { let grain = (Math.random()-0.5) * state.noiseLevel * 20; r+=grain; g+=grain; b+=grain; } }
                
                if(usePalette) { 
                    let lum = (0.299*r + 0.587*g + 0.114*b) * i; 
                    let colIdx = Math.floor((x + y + t*2) % activeColors.length); 
                    if (colIdx < 0 || isNaN(colIdx)) colIdx = 0; // safety
                    let col = activeColors[colIdx]; 
                    data[idx]=col.r * (lum/255); data[idx+1]=col.g * (lum/255); data[idx+2]=col.b * (lum/255); data[idx+3]=255; 
                } 
                else { data[idx]=r*i; data[idx+1]=g*i; data[idx+2]=b*i; data[idx+3]=255; }
            }
            const hsl = (idx, hVal, sVal, lVal, x, y) => { const rgb=hslToRgb(hVal,sVal,lVal); p(idx, rgb[0],rgb[1],rgb[2], 1, x, y); }

            for(let y=0; y<h; y++) {
                for(let x=0; x<w; x++) {
                    const idx = (y*w+x)*4;
                    const u = (x + 0.5) / w; const v = (y + 0.5) / h; 
                    const rnd = Math.random();

                    switch(state.fxMode) {
                        case 0: p(idx, rB,gB,bB, 1, x, y); break;
                        case 1: p(idx,(Math.floor(t*6)%2 ? (u<0.5?0:255) : (u<0.5?255:0)), 0, (Math.floor(t*6)%2 ? (u<0.5?255:0) : (u<0.5?0:255)), (Math.floor(t*20)%2?1:0), x, y); break;
                        case 2: { const n=(Math.sin(t*10 + u*10) + Math.sin(t*20 + v*10))/2 + 0.5; p(idx,255, 50+n*100, 0, 0.5+n*0.5, x, y); break; }
                        case 3: p(idx,255,255,255, rnd>0.96?1:0, x, y); break;
                        case 4: { let i=0.5+rnd*0.5; if((y+Math.floor(t*10))%5===0)i*=0.8; p(idx,200,220,255,i, x, y); break; }
                        case 5: p(idx,200,230,255, (Math.sin(t*3)>0.9 && rnd>0.5)?1:0.05, x, y); break;
                        case 6: p(idx,255,180,100, Math.max(0, 1 - Math.abs(u - ((t*0.5)%1)) * 5), x, y); break;
                        case 7: p(idx,220,255,220, (rnd>0.9 || Math.sin(t)>0.8)?0.2:1, x, y); break;
                        case 8: p(idx,255,255,255, stormFlash, x, y); break;
                        case 9: { let f=Math.sin(t*10)+Math.sin(t*23); p(idx,255,150,50, 0.6+f*0.1, x, y); break; }
                        case 10: p(idx,255,255,255, Math.floor(t*30)%2?1:0, x, y); break;
                        case 11: { let tr=t%3; p(idx,255, (tr<0.2)?255:100, (tr<0.2)?255:0, (tr<1)?(tr<0.2?1:1-(tr-0.2)):0, x, y); break; }
                        case 12: hsl(idx, (t*50)%360, 100, 50, x, y); break;
                        case 13: hsl(idx, rnd*360, 100, rnd>0.96?50:0, x, y); break;
                        case 14: p(idx,200,255,220, (t%2<0.1 || rnd>0.95)?0:1, x, y); break;
                        case 15: { let rot = (Math.atan2(v-0.5, u-0.5) + t*5) % (Math.PI*2); p(idx,255, rot>0?150:0, 0, 1, x, y); break; }
                        case 16: if(rnd>0.99) hsl(idx,rnd*360,100,50, x, y); else p(idx,0,0,0,0.9, x, y); break;
                        case 17: { let bang = t%1; p(idx,255,200,150, bang<0.05?1:0, x, y); break; }
                        case 18: p(idx,255,0,0, 0.5+Math.sin(t*5)*0.5, x, y); break;
                        case 19: p(idx,255,200,150, (v + t*0.5)%1 < 0.2 ? 1 : 0, x, y); break;
                        case 20: { let flicker=rnd>0.9?0:1; p(idx,50,100,50, flicker*0.5, x, y); break; }
                        /* SHNOPIA FX */
                        case 21: hsl(idx, 140+Math.max(0,50-Math.abs(v-(0.5+Math.sin(u*5+t)*0.1))*100), 100, 50, x, y); break;
                        case 22: { let r=(v + t)%1; hsl(idx, 120, 100, (Math.abs(v-r)<0.1 && rnd>0.8)?50:0, x, y); break; }
                        case 23: hsl(idx, ((u+v)%0.2 < 0.1)?300:180, 100, 30+Math.sin(t*5)*20, x, y); break;
                        case 24: hsl(idx, (Math.sin(u*5+t)+Math.sin(v*5+t))*40%360, 100, 50, x, y); break;
                        case 25: hsl(idx, 200+Math.sin(u*10+t)*10, 80, 40, x, y); break;
                        case 26: { let n=Math.sin(u*4+t)+Math.cos(v*4+t); hsl(idx, 10+n*10, 100, 40+n*20, x, y); break; }
                        case 27: hsl(idx, (t*40+u*100)%360, 100, 50, x, y); break;
                        case 28: hsl(idx, 280-v*60, 80, 50, x, y); break;
                        case 29: { let noise = Math.sin(u*5)*Math.cos(v*5+t); hsl(idx, 260+noise*30, 80, 20+noise*20, x, y); break; }
                        case 30: hsl(idx, u*360 + t*50, 100, 50, x, y); break;
                        case 31: p(idx,255,0,0, Math.abs(u - (Math.sin(t)*0.4 + 0.5)) < 0.05 ? 1 : 0, x, y); break;
                        case 32: { let dist=Math.sqrt((u-0.5)**2+(v-0.5)**2); hsl(idx, 200, 100, Math.sin(dist*10 - t*5)*50+50, x, y); break; }
                        case 33: p(idx,255,255,255, rnd>0.95?1:0, x, y); break;
                        case 34: if(rnd>0.9) hsl(idx, rnd*360, 100, 50, x, y); else p(idx,0,0,0, 1, x, y); break;
                        case 35: p(idx,0,255,0, (Math.floor(u*10+v*10+t)%2)?1:0, x, y); break;
                        case 36: p(idx,255,0,0, Math.pow(Math.sin(t*5), 10), x, y); break;
                        case 37: hsl(idx, 100, 100, 20+Math.sin(u*10+t)*20, x, y); break;
                        case 38: p(idx,255,255,255, (Math.abs(u-0.5)<v)?1:0, x, y); break;
                        case 39: hsl(idx, 220, 100, rnd>0.9 ? 80 : 0, x, y); break;
                        case 40: { let ang=Math.atan2(v-0.5, u-0.5)+t; hsl(idx, ang*50, 100, 50, x, y); break; }
                        case 41: { let mx=Math.abs(u-0.5), my=Math.abs(v-0.5); hsl(idx, (mx*my*100+t*100)%360, 100, 50, x, y); break; }
                    }
                }
            }
            ctx.putImageData(imgData, 0, 0);
            
            if(state.dimmer < 100) { ctx.fillStyle=`rgba(0,0,0, ${1-state.dimmer/100})`; ctx.fillRect(0,0,w,h); }

            previewCtx.clearRect(0,0,previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);

            textCtx.clearRect(0, 0, textCanvas.width, textCanvas.height);
            if(state.textOn && state.textString) {
                const fontSize = Math.max(20, textCanvas.height * (state.textSize/100));
                textCtx.font = `bold ${fontSize}px ${state.textFont}`; 
                textCtx.fillStyle = state.textColor; textCtx.textBaseline = "middle"; textCtx.globalAlpha = state.dimmer / 100;
                const textWidth = textCtx.measureText(state.textString).width;
                if(state.textSpeed > 0) { const speed = (state.textSpeed / 10) * (textCanvas.width / 100) + 0.1; state.textPos -= speed; if(state.textPos < -textWidth) state.textPos = textCanvas.width; } 
                else { state.textPos = (textCanvas.width - textWidth) / 2; }
                const x = state.textPos; const y = textCanvas.height/2; const lvl = state.textFxLvl / 100;
                
                if(state.textEffect === "NONE") { textCtx.fillText(state.textString, x, y); }
                else if(state.textEffect === "NEON") { textCtx.shadowBlur = 20 * lvl + 5; textCtx.shadowColor = state.textColor; textCtx.fillStyle = "#ffffff"; textCtx.fillText(state.textString, x, y); textCtx.shadowBlur = 0; }
                else if(state.textEffect === "GLITCH") { if(Math.random() < lvl) { textCtx.fillStyle = "red"; textCtx.fillText(state.textString, x + (Math.random()-0.5)*10*lvl, y); textCtx.fillStyle = "blue"; textCtx.fillText(state.textString, x, y + (Math.random()-0.5)*10*lvl); } textCtx.fillStyle = state.textColor; textCtx.fillText(state.textString, x, y); }
                else if(state.textEffect === "WAVE") { textCtx.fillStyle = state.textColor; for (let i = 0; i < state.textString.length; i++) { const char = state.textString[i]; const yOff = Math.sin(t*5 + i*0.5) * (50 * lvl); textCtx.fillText(char, x + (i*fontSize*0.6), y + yOff); } }
                else if(state.textEffect === "TYPE") { const len = Math.floor(state.textString.length * ((Math.sin(t)+1)/2)); textCtx.fillText(state.textString.substring(0, len), x, y); }
                else if(state.textEffect === "STROKE") { textCtx.lineWidth = 2 + 5*lvl; textCtx.strokeStyle = state.textColor; textCtx.strokeText(state.textString, x, y); }
                textCtx.globalAlpha = 1;
            }
            requestAnimationFrame(render);
        }

        // --- INTERACTION ---
        window.switchTab = (id, btn) => { document.querySelectorAll('.panel-content').forEach(e => e.classList.remove('visible')); document.getElementById(id).classList.add('visible'); document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active')); if(btn) btn.classList.add('active'); };
        window.setEffect = (id, el) => { state.fxMode = id; state.mode = 'FX'; document.querySelectorAll('.fx-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); };
        
        window.setKelvin = (k) => { 
            state.kelvin = k; 
            document.getElementById('input-kelvin').value = k; document.getElementById('val-kelvin').innerText = k + "K";
            const rgb = applyTint(kelvinToRgb(k), state.tint);
            updateWhiteUI(rgb);
            activateStatic('CCT'); 
        };

        window.setMapMode = (idx, el) => { state.mapMode = idx; document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active-map')); el.classList.add('active-map'); };
        
        window.activateStatic = (mode) => {
            state.fxMode = 0; state.mode = mode; 
            document.querySelectorAll('.fx-card').forEach(c => c.classList.remove('active'));
            document.getElementById('fx-static').classList.add('active');
        };
        
        window.recallWhite = () => {
            const rgb = state.whiteRgb;
            document.getElementById('input-r').value = Math.round(rgb.r);
            document.getElementById('input-g').value = Math.round(rgb.g);
            document.getElementById('input-b').value = Math.round(rgb.b);
            updateFromRGB(); 
            activateStatic('WHEEL');
        };

        function updateRangeStyle(input, active) {
            if (active) input.classList.add('active'); else input.classList.remove('active');
            if (active) input.parentElement.classList.add('active'); else input.parentElement.classList.remove('active');
        }

        window.updateGridSlider = (el) => { 
            state.gridLevel = parseInt(el.value); 
            state.gridActive = (state.gridLevel > 1);
            const val = document.getElementById('val-grid-lvl'); 
            val.innerText = `x${state.gridLevel}`;
            updateRangeStyle(el, state.gridActive);
            if(state.gridActive) val.style.color = '#0f0'; else val.style.color = '#888';
        };

        window.updateWarpSlider = (el) => { 
            state.warpLevel = parseInt(el.value);
            state.warpActive = (state.warpLevel > 0);
            const val = document.getElementById('val-warp-lvl');
            val.innerText = state.warpLevel;
            updateRangeStyle(el, state.warpActive);
            if(state.warpActive) val.style.color = '#0f0'; else val.style.color = '#888';
        };

        window.updateNoiseSlider = (el) => { 
            state.noiseLevel = parseInt(el.value);
            state.noiseActive = (state.noiseLevel > 0);
            const val = document.getElementById('val-noise-lvl');
            val.innerText = state.noiseLevel;
            updateRangeStyle(el, state.noiseActive);
            if(state.noiseActive) val.style.color = '#0f0'; else val.style.color = '#888';
        };

        window.updateTextSlider = () => {
            const input = document.getElementById('input-text-fx-lvl');
            const val = parseInt(input.value);
            state.textFxLvl = val;
            document.getElementById('val-text-fx-lvl').innerText = val + "%";
            updateRangeStyle(input, val > 0);
            if(val > 0) document.getElementById('val-text-fx-lvl').style.color = '#0f0'; else document.getElementById('val-text-fx-lvl').style.color = '#888';
        };

        window.toggleBlackout = () => { state.blackout = !state.blackout; const btn = document.getElementById('btn-blackout'); if(state.blackout) btn.classList.add('active'); else btn.classList.remove('active'); };
        
        window.toggleFS = () => { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); };
        window.togglePreviewFS = () => { minimizePanel(); if(!document.fullscreenElement) document.documentElement.requestFullscreen(); };
        
        document.addEventListener("fullscreenchange", () => {
             const btn = document.querySelector('.fullscreen-btn');
             if (document.fullscreenElement) btn.classList.add('active');
             else btn.classList.remove('active');
        });
        
        window.toggleText = () => { 
            state.textOn = !state.textOn; 
            const btn = document.getElementById('btn-text-toggle'); 
            if(state.textOn) { btn.innerText = "TEXTE: ON"; btn.classList.add('active'); state.textPos = textCanvas.width; } 
            else { btn.innerText = "TEXTE: OFF"; btn.classList.remove('active'); } 
        };

        window.minimizePanel = () => { document.getElementById('main-panel').classList.add('hidden'); };
        window.restorePanel = () => { document.getElementById('main-panel').classList.remove('hidden'); };
        
        function handleGlobalClick(e) { 
            const panel = document.getElementById('main-panel'); 
            if (panel.classList.contains('hidden')) { 
                restorePanel();
            } else { 
                if (e.target.id !== 'modal-overlay') { 
                    minimizePanel();
                    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                }
            } 
        }

        window.showCustomMatrixModal = () => { document.getElementById('modal-overlay').style.display = 'flex'; };
        window.closeModalOnOutside = (e) => { if(e.target.id === 'modal-overlay') document.getElementById('modal-overlay').style.display = 'none'; };
        
        window.applyCustomMatrix = () => {
            const w = parseInt(document.getElementById('custom-w').value) || 1;
            const h = parseInt(document.getElementById('custom-h').value) || 1;
            MAPS[14] = {w: w, h: h};
            state.mapMode = 14; 
            setMapMode(14, document.getElementById('btn-set'));
            document.getElementById('set-display').innerText = `${w}x${h}`;
            document.getElementById('set-display').style.color = '#0f0';
            document.getElementById('modal-overlay').style.display = 'none';
        };

        document.getElementById('text-content').oninput = e => state.textString = e.target.value;
        document.getElementById('input-text-size').oninput = e => { state.textSize = parseInt(e.target.value); document.getElementById('val-text-size').innerText = state.textSize + "%"; };
        document.getElementById('input-text-speed').oninput = e => { state.textSpeed = parseInt(e.target.value); document.getElementById('val-text-speed').innerText = state.textSpeed; };
        document.getElementById('input-text-color').oninput = e => state.textColor = e.target.value;
        document.getElementById('input-text-font').onchange = e => state.textFont = e.target.value;
        document.getElementById('input-text-effect').onchange = e => state.textEffect = e.target.value;
        
        document.getElementById('input-dimmer').oninput = e => { state.dimmer = parseInt(e.target.value); document.getElementById('val-dimmer').innerText = state.dimmer + "%"; };
        document.getElementById('input-speed').oninput = e => { state.speedCinema = parseInt(e.target.value); document.getElementById('val-speed').innerText = state.speedCinema + "%"; };
        document.getElementById('input-speed-shnopia').oninput = e => { state.speedShnopia = parseInt(e.target.value); document.getElementById('val-speed-shnopia').innerText = state.speedShnopia + "%"; };
        
        document.getElementById('input-sat').oninput = e => { 
            state.sat = e.target.value; 
            // In HSV logic, manually adjusting SAT implies full VALUE
            state.val = 100; 
            document.getElementById('val-sat').innerText = state.sat + "%"; 
            
            // Calculate HSV -> RGB
            const rgb = hsvToRgb(state.hue, state.sat, state.val); 
            document.getElementById('hex-input').value = rgbToHex(rgb[0], rgb[1], rgb[2]); 
            updateRGBInputs(rgb);
            
            updateCursorVisuals();
            activateStatic('WHEEL');
        };
        
        document.getElementById('input-kelvin').oninput = e => { 
            state.kelvin = parseInt(e.target.value); 
            updateCCT();
        };
        document.getElementById('input-tint').oninput = e => { 
            state.tint = e.target.value; 
            updateCCT();
        };
        
        function updateCCT() {
           const k = state.kelvin; const t = state.tint;
           document.getElementById('val-kelvin').innerText = k + "K"; document.getElementById('val-tint').innerText = t;
           const rgb = applyTint(kelvinToRgb(k), t);
           updateWhiteUI(rgb); activateStatic('CCT');
        }
        function updateWhiteUI(rgb) {
            state.whiteRgb = rgb;
            document.getElementById('input-white-r').value = Math.round(rgb.r);
            document.getElementById('input-white-g').value = Math.round(rgb.g);
            document.getElementById('input-white-b').value = Math.round(rgb.b);
            document.getElementById('hex-input-white').value = rgbToHex(rgb.r, rgb.g, rgb.b);
        }
        function updateFromWhiteRGB() {
            const r = parseInt(document.getElementById('input-white-r').value); const g = parseInt(document.getElementById('input-white-g').value); const b = parseInt(document.getElementById('input-white-b').value);
            state.whiteRgb = {r:r, g:g, b:b}; document.getElementById('hex-input-white').value = rgbToHex(r, g, b); activateStatic('CCT');
        }
        ['input-white-r', 'input-white-g', 'input-white-b'].forEach(id => document.getElementById(id).addEventListener('input', updateFromWhiteRGB));
        document.getElementById('hex-input-white').addEventListener('change', e => { let hex = e.target.value; if(!hex.startsWith('#')) hex='#'+hex; const rgb = hexToRgb(hex); state.whiteRgb = rgb; document.getElementById('input-white-r').value = rgb.r; document.getElementById('input-white-g').value = rgb.g; document.getElementById('input-white-b').value = rgb.b; activateStatic('CCT'); });

        function updateRGBInputs(rgb) { document.getElementById('input-r').value = Math.round(rgb[0] || rgb.r); document.getElementById('input-g').value = Math.round(rgb[1] || rgb.g); document.getElementById('input-b').value = Math.round(rgb[2] || rgb.b); }
        
        function updateFromRGB() {
             const r = parseInt(document.getElementById('input-r').value); const g = parseInt(document.getElementById('input-g').value); const b = parseInt(document.getElementById('input-b').value);
             const hex = rgbToHex(r, g, b); const hsv = rgbToHsv(r, g, b);
             
             state.hue = hsv.h; 
             state.sat = hsv.s; // This is now HSV Saturation (correct for UI distance)
             state.val = hsv.v; // This is Brightness/Value
             
             document.getElementById('hex-input').value = hex;
             document.getElementById('input-sat').value = state.sat; document.getElementById('val-sat').innerText = Math.round(state.sat)+"%";
             
             updateCursorVisuals();
        }
        
        function updateCursorVisuals() {
            const container = document.getElementById('color-wheel');
            const cursor = document.getElementById('wheel-cursor');
            const rect = container.getBoundingClientRect();
            const radius = rect.width / 2;
            const rad = (state.hue - 90) * (Math.PI / 180);
            const dist = (state.sat / 100) * radius;
            const x = radius + Math.cos(rad) * dist;
            const y = radius + Math.sin(rad) * dist;
            cursor.style.left = x + 'px';
            cursor.style.top = y + 'px';
        }
        
        window.addEventListener('resize', () => { if(state.mode === 'WHEEL') updateCursorVisuals(); });

        ['input-r', 'input-g', 'input-b'].forEach(id => { document.getElementById(id).addEventListener('input', () => { updateFromRGB(); activateStatic('WHEEL'); }); });

        // WHEEL LOGIC
        const wheel = document.getElementById('color-wheel'); const cursor = document.getElementById('wheel-cursor'); const hexInput = document.getElementById('hex-input');
        let isWheelDrag = false;
        function updateWheel(e) {
            const rect = wheel.getBoundingClientRect(); const radius = rect.width / 2;
            const x = e.touches ? e.touches[0].clientX : e.clientX; const y = e.touches ? e.touches[0].clientY : e.clientY;
            const cx = rect.left + radius; const cy = rect.top + radius;
            const dx = x - cx; const dy = y - cy;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), radius);
            let ang = Math.atan2(dy, dx) * (180 / Math.PI); if(ang < 0) ang += 360;
            
            state.hue = (ang + 90) % 360;
            state.sat = (dist / radius) * 100;
            state.val = 100; // Reset value to 100 on touch

            document.getElementById('input-sat').value = state.sat; document.getElementById('val-sat').innerText = Math.round(state.sat) + "%";
            
            updateCursorVisuals(); 
            
            const rgb = hsvToRgb(state.hue, state.sat, 100); 
            hexInput.value = rgbToHex(rgb[0], rgb[1], rgb[2]); 
            updateRGBInputs(rgb); 
        }

        hexInput.addEventListener('change', (e) => {
            let hex = e.target.value; if(!hex.startsWith('#')) hex = '#' + hex;
            const rgb = hexToRgb(hex); 
            document.getElementById('input-r').value = rgb.r;
            document.getElementById('input-g').value = rgb.g;
            document.getElementById('input-b').value = rgb.b;
            updateFromRGB(); 
            activateStatic('WHEEL');
        });
        
        cursor.style.left = '90px'; cursor.style.top = (90 - 80) + 'px';

        wheel.addEventListener('mousedown', e => { isWheelDrag=true; activateStatic('WHEEL'); updateWheel(e); }); 
        window.addEventListener('mousemove', e => { if(isWheelDrag) { e.preventDefault(); updateWheel(e); } }); 
        window.addEventListener('mouseup', () => isWheelDrag=false);
        wheel.addEventListener('touchstart', e => { isWheelDrag=true; activateStatic('WHEEL'); updateWheel(e); }, {passive:false}); 
        window.addEventListener('touchmove', e => { if(isWheelDrag) { e.preventDefault(); updateWheel(e); } }, {passive:false}); 
        window.addEventListener('touchend', () => isWheelDrag=false);

        // DRAG PANEL
        const panel = document.getElementById('main-panel'); const handle = document.getElementById('drag-handle'); let isDrag=false, startX, startY, initL, initT;
        handle.addEventListener('mousedown', e => { isDrag=true; startX=e.clientX; startY=e.clientY; const r=panel.getBoundingClientRect(); panel.style.transform='none'; panel.style.left=r.left+'px'; panel.style.top=r.top+'px'; initL=r.left; initT=r.top; });
        window.addEventListener('mousemove', e => { if(isDrag){ panel.style.left=(initL+(e.clientX-startX))+'px'; panel.style.top=(initT+(e.clientY-startY))+'px'; }});
        window.addEventListener('mouseup', ()=>isDrag=false);

        function syncUI() {
            document.getElementById('val-sat').innerText = Math.round(state.sat) + "%"; document.getElementById('val-kelvin').innerText = state.kelvin + "K"; document.getElementById('val-tint').innerText = state.tint;
            document.getElementById('val-speed').innerText = state.speedCinema + "%"; document.getElementById('val-speed-shnopia').innerText = state.speedShnopia + "%";
            document.getElementById('val-text-size').innerText = state.textSize + "%"; document.getElementById('val-text-speed').innerText = state.textSpeed; document.getElementById('val-dimmer').innerText = state.dimmer + "%";
            
            document.getElementById('input-sat').value = state.sat; document.getElementById('input-kelvin').value = state.kelvin; document.getElementById('input-tint').value = state.tint;
            document.getElementById('input-speed').value = state.speedCinema; document.getElementById('input-speed-shnopia').value = state.speedShnopia;
            document.getElementById('input-text-size').value = state.textSize; document.getElementById('input-text-speed').value = state.textSpeed; document.getElementById('input-dimmer').value = state.dimmer;
            
            const rgb = hsvToRgb(state.hue, state.sat, 100); updateRGBInputs(rgb);
            const wRgb = applyTint(kelvinToRgb(state.kelvin), state.tint); updateWhiteUI(wRgb);

            updateGridSlider(document.getElementById('input-grid-lvl'));
            updateWarpSlider(document.getElementById('input-warp-lvl'));
            updateNoiseSlider(document.getElementById('input-noise-lvl'));
            updateTextSlider();
            
            if (document.fullscreenElement) document.querySelector('.fullscreen-btn').classList.add('active');
            
            // Initial call to set cursor pos
            setTimeout(updateCursorVisuals, 100);
        }
        syncUI();
        requestAnimationFrame(render);
    </script>
</body>
</html>